<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.4"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>fdc_bitstream: C++ FDC library to manipulate 2D/MFM bitstream image data</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">fdc_bitstream
   </div>
   <div id="projectbrief">FDC library for MFM floppy bit stream data.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.4 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md__r_e_a_d_m_e.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">C++ FDC library to manipulate 2D/MFM bitstream image data </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p >Work in progress.</p>
<h1><a class="anchor" id="autotoc_md1"></a>
Description:</h1>
<p >This is a C++ library to provide FDC functions. Read and write functions mimic the actual operation of the Western Digital FD179x or Fujitsu MB8876 FDCs. The FDC library is designed to be integrated with the old PC emulator programs. <br  />
</p>
<p >This FDC library can handle raw FDD output read data before the C/D separation is applied. <br  />
 The FDC library includes a data separator and simple VFO emulation features thus, the FDC can reproduce some copy protection data, which requires precise sub-bitrate data pulse timing. <br  />
</p>
<p ><b>This library directly reads and writes the bit stream data, so the track bit stream data even after applying some write operations, is still compliant with actual floppy bit stream data.</b> <br  />
</p>
<h2><a class="anchor" id="autotoc_md2"></a>
Supported functions:</h2>
<ul>
<li>Track read</li>
<li>Track write</li>
<li>ID read</li>
<li>Sector read</li>
<li>Sector write</li>
</ul>
<h2><a class="anchor" id="autotoc_md3"></a>
Supported floppy disk image formats:</h2>
<p >You can use <code>*.HFE</code> (for HxC floppy emulator), <code>*.MFM</code> (my original disk format), and <code>*.RAW</code> (which can be generated by <a href="https://github.com/yas-sim/floppy_disk_shield_2d">floppy_disk_shield_2d</a>). The specification of the <code>MFM</code> and <code>RAW</code> formats was defined by me. That format can preserve precise sub-bitrate pulse data. By default, these file formats will capture the FDD RD data at the sampling rate of 4MHz. <br  />
</p>
<h1><a class="anchor" id="autotoc_md4"></a>
API Document</h1>
<p >The API document generated by Doxygen can be found at <code>./docs/html</code> directory. Please open <a href="./docs/html/index.html"><code>./docs/html/index.html</code></a> with a browser. <br  />
 <em>Note:</em> You can't open the HTML document from GitHub. Please clone the project and open the document locally. <br  />
</p>
<h1><a class="anchor" id="autotoc_md5"></a>
How to integrate the fdc_bitstream library with your program</h1>
<ol type="1">
<li>Required files <br  />
</li>
</ol>
<ul>
<li>Source codes: All C++ source codes are stored in the <code>./fdc_bitstream</code> directory. <br  />
</li>
<li>Header files: All C++ header files are stored in the <code>./includes</code> directory.</li>
</ul>
<ol type="1">
<li>Classes</li>
</ol>
<ul>
<li>Use the <code><a class="el" href="classfdc__bitstream.html">fdc_bitstream</a></code> object to access the track data. <br  />
 = <code><a class="el" href="classfdc__bitstream.html">fdc_bitstream</a></code> takes track data in a <code><a class="el" href="classbit__array.html">bit_array</a></code> object and performs read and write operations. <br  />
 = <code><a class="el" href="classfdc__bitstream.html">fdc_bitstream</a></code> doesn't provide <em>seek</em> and <em>restore</em> functions. It simply provides read and write functions for the track data provided. The user program must handle <em>seek</em> and <em>restore</em> equivalent operations. <br  />
</li>
<li>Track data is held in the <code><a class="el" href="classbit__array.html">bit_array</a></code> object. <br  />
 = You can access the data with <em>bit address</em> with <code><a class="el" href="classbit__array.html">bit_array</a></code> object. <br  />
 = <code><a class="el" href="classbit__array.html">bit_array</a></code> object has an internal access pointer and provides streaming access. You can read and write bit data sequentially with the streaming functions. <br  />
 = You can choose two modes when you access by the streaming functions. One is ring-buffer mode, and the other one is elastic buffer mode. <br  />
 = In ring-buffer mode, you can access the bit data with the auto-increment pointer, and the pointer will go back to the top when it reaches the end of the buffer. <br  />
 = In elastic buffer mode, the buffer will automatically extend as you write over the end of the buffer. <br  />
<ul>
<li>Use one of the <code>disk_image_???</code> class to read the disk image file. Supported formats are <code>HFE</code>, <code>MFM</code>, and <code>RAW</code> (<code>MFM</code> and <code>RAW</code> are my original format. It is not compatible any other existing disk formats which shares the same file extension). <br  />
</li>
</ul>
</li>
</ul>
<p ><img src="./resources/class-diagram.png" alt="" class="inline"/></p>
<h1><a class="anchor" id="autotoc_md6"></a>
HFE to MFM format converter</h1>
<p >This project also includes a <em>simple</em> disk image converter that takes an <code>*.HFE</code> disk image data and generates an <code>*.MFM</code> disk image data. <br  />
</p><ul>
<li>How to run: <div class="fragment"><div class="line">hfe2mfm input_file.hfe</div>
</div><!-- fragment --> Note: <code>hfe2mfm</code> swaps the file extension from <code>*.hfe</code> to <code>*.mfm</code> and generates the output file. <br  />
</li>
</ul>
<h1><a class="anchor" id="autotoc_md7"></a>
Directory structure</h1>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Directory   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code><a class="el" href="classfdc__bitstream.html">fdc_bitstream</a></code>   </td><td class="markdownTableBodyNone">C++ FDC library source code    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>include</code>   </td><td class="markdownTableBodyNone">C++ header files for the FDC library    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>fdc_test</code>   </td><td class="markdownTableBodyNone">FDC lib test program source code    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>docs/html</code>   </td><td class="markdownTableBodyNone">FDC library API document (<code>index.html</code>)    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>hfe2mfm</code>   </td><td class="markdownTableBodyNone">HFE to MFM floppy disk image converter source code   </td></tr>
</table>
<h1><a class="anchor" id="autotoc_md8"></a>
How to build the test program and HFE to MFM image converter</h1>
<p >Build tested on Windows 11 (MSVC), and Linux (Ubuntu20, gcc). <br  />
 </p><div class="fragment"><div class="line">mkdir build</div>
<div class="line">cd build</div>
<div class="line">cmake ..</div>
<div class="line">cmake --build .</div>
</div><!-- fragment --><hr  />
 <h1><a class="anchor" id="autotoc_md10"></a>
Test program and Sample programs</h1>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Program Name   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>fdc_test</code>   </td><td class="markdownTableBodyNone"><code>fdc_bistream</code> sample code. You can learn how to use <code>bit_stream</code> and <code>image_???</code> classes.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>create_mfm_image</code>   </td><td class="markdownTableBodyNone">Sample program to create a 2D/MFM formatted <code>.mfm</code> disk image. The program will create <code>new_image.mfm</code>.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>check_mfm_imge</code>   </td><td class="markdownTableBodyNone">Read <code>image.mfm</code> file and perform read track and sector ID read for all tracks. The result of track read and ID read operations will be displayed on the console.   </td></tr>
</table>
<hr  />
<h1><a class="anchor" id="autotoc_md12"></a>
MFM image data format:</h1>
<p >The default sampling rate for the MFM format is 4MHz. The data rate of an orginary 2D/MFM format data is 500KHz. This means, one bit cell will be recorded with eight bits of data in the MFM format. <br  />
</p>
<p ><code>|00001000|00000000|00100000|00010000|00000000| =&gt; 0x08,0x00,0x20,0x10,0x00 in MFM format</code></p>
<div class="fragment"><div class="line"> {C++}</div>
<div class="line">// Header (ofst(byte) = 0)</div>
<div class="line">typedef struct mfm_header_ {</div>
<div class="line">    uint8_t     id_str[8];                  //  &quot;MFM_IMG &quot;</div>
<div class="line">    uint64_t    track_table_offset;         // </div>
<div class="line">    uint64_t    number_of_tracks;           //</div>
<div class="line">    uint64_t    spindle_time_ns;            //  Time for 1 rotation (ns unit) </div>
<div class="line">    uint64_t    data_bit_rate;              //  Data bit rate (bit/sec)    MFM=500Kbit/sec = 500,000</div>
<div class="line">    uint64_t    sampling_rate;              //  Sampling rate of the bit stream data     4MHz = 4,000,000</div>
<div class="line">} mfm_header;</div>
<div class="line"> </div>
<div class="line">// Track offset table (ofst(byte) = header.track_table_offset)</div>
<div class="line">typedef struct track_table_ {</div>
<div class="line">    uint64_t    offset;                     // Offset to the track data (unit=byte, from the top of the file == absolute offset)</div>
<div class="line">    uint64_t    length_bit;                 // Track data length (uint=bits, not bytes)</div>
<div class="line">} mfm_track_table;</div>
<div class="line"> </div>
<div class="line">// Track data * 84</div>
<div class="line">//   ofst(byte) = track_table[track#].offset</div>
<div class="line">//   size(byte) = track_table[track#].length_bit/8 + (track_table[track#].length%8)?1:0)</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.4 </li>
  </ul>
</div>
</body>
</html>
